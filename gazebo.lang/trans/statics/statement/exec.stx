module statics/statement/exec

imports

    statics/common
    statics/statement/block
    statics/expr

rules // entry point

    execOk : scope * Exec

    execOk(s, ExecFin(frag, body)) :- {s_exec_body}
        execFragOk(s, frag),
        new s_exec_body, s_exec_body -P-> s,
        blockOk(s_exec_body, body).

    execOk(s, ExecChain(frag, next)) :-
        // exec chain is typed just like a single-statement body
        execOk(s, ExecFin(frag, SingleStmt(Exec2Statement(next)))).

rules // fragments

    execFragOk : scope * ExecFrag

    execFragOk(s, ExecAlign(e)) :- {T}
        typeOfExpr(s, e) == T,
        try { false } | note $[todo: assert ^ct string]@e.

    execFragOk(s, ExecAnchored(a)).

    execFragOk(s, ExecAs(t)) :- {T}
        typeOfExpr(s, t) == T@SELECTOR(_) | error $[target is not a selector, but instead [T]]@t.

    execFragOk(s, ExecAt(t)) :- {T}
        typeOfExpr(s, t) == T@SELECTOR(_) | error $[target is not a selector, but instead [T]]@t.

    execFragOk(s, ExecFacingPos(p)) :- {T}
        typeOfExpr(s, p) == T,
        try { false } | note $[todo: assert ^ct pos]@p.

    execFragOk(s, ExecFacingEntity(t, a)) :- {T}
        typeOfExpr(s, t) == T@SELECTOR(_) | error $[target is not a selector, but instead [T]]@t.

    execFragOk(s, ExecIn(dim)) :- {T}
        typeOfExpr(s, dim) == T,
        try { false } | note $[todo: assert ^ct and dim registry]@dim.

    execFragOk(s, ExecPositionedPos(p)) :- {T}
        typeOfExpr(s, p) == T,
        try { false } | note $[todo: assert ^ct pos]@p.

    execFragOk(s, ExecPositionedAs(t)) :- {T}
        typeOfExpr(s, t) == T@SELECTOR(_) | error $[target is not a selector, but instead [T]]@t.

    execFragOk(s, ExecRotatedAbs(r)) :- {T}
        typeOfExpr(s, r) == T,
        try { false } | note $[todo: assert ^ct double]@r.

    execFragOk(s, ExecRotatedRel(r)) :- {T}
        typeOfExpr(s, r) == T,
        try { false } | note $[todo: assert ^ct double]@r.

    execFragOk(s, ExecRotatedAs(t)) :- {T}
        typeOfExpr(s, t) == T@SELECTOR(_) | error $[target is not a selector, but instead [T]]@t.
